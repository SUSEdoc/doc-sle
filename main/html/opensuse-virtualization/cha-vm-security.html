<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Enhancing virtual machine security with AMD SEV-SNP | Virtualization Guide | openSUSE Leap 15.6</title><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" /><link rel="stylesheet" type="text/css" href="static/css/style.css" /><link rel="stylesheet" type="text/css" href="static/css/highlight.css" />
<meta name="title" content="Enhancing virtual machine security with AMD SEV-SNP | …" />
<meta name="description" content="You can enhance the security of your virtual machines with AMD Secure Encrypted Virtualization-Secure Nested Paging (SEV-SNP). The AMD SEV-SNP feature isolates…" />
<meta name="product-name" content="openSUSE Leap" />
<meta name="product-number" content="15.6" />
<meta name="book-title" content="Virtualization Guide" />
<meta name="chapter-title" content="Chapter 15. Enhancing virtual machine security with AMD SEV-SNP" />
<meta name="tracker-url" content="https://bugzilla.opensuse.org/enter_bug.cgi" />
<meta name="tracker-type" content="bsc" />
<meta name="tracker-bsc-assignee" content="fs@suse.com" />
<meta name="tracker-bsc-component" content="Documentation" />
<meta name="tracker-bsc-product" content="openSUSE Distribution" />
<meta name="tracker-bsc-version" content="Leap 15.4" />
<meta property="og:title" content="Enhancing virtual machine security with AMD SEV-SNP | …" />
<meta property="og:description" content="You can enhance the security of your virtual machines with AMD Secure Encrypted Virtualization-Secure Nested Paging (SEV-SNP). The AMD SEV-SNP feature isolates…" />
<meta property="og:type" content="article" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Enhancing virtual machine security with AMD SEV-SNP | …" />
<meta name="twitter:description" content="You can enhance the security of your virtual machines with AMD Secure Encrypted Virtualization-Secure Nested Paging (SEV-SNP). The AMD SEV-SNP feature isolates…" />
<link rel="home" href="index.html" title="openSUSE Leap Documentation" /><link rel="up" href="part-virt-libvirt.html" title="Part II. Managing virtual machines with libvirt" /><link rel="prev" href="cha-libvirt-config-virsh.html" title="Chapter 14. Configuring virtual machines with virsh" /><link rel="next" href="sec-libvirt-admin-migrate.html" title="Chapter 16. Migrating VM Guests" />
<script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"></link>');
};

</script><noscript><link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css" /></noscript><script src="static/js/jquery-1.12.4.min.js" type="text/javascript"></script><script src="static/js/script.js" type="text/javascript"></script><script src="static/js/highlight.min.js" type="text/javascript"></script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script></head><body class="draft offline js-off" onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-navigation">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><div id="_outer-wrap"><div id="_white-bg" style="background-color: #E11;"><div id="_header"><div id="_logo"><img src="static/images/logo.svg" alt="Logo" /></div><div class="crumbs"><a class="book-link" href="index.html" title="Virtualization Guide"><span class="book-icon">Virtualization Guide</span></a><span> › </span><a class="crumb" href="part-virt-libvirt.html">Managing virtual machines with libvirt</a><span> › </span><a class="crumb" href="cha-vm-security.html">Enhancing virtual machine security with AMD SEV-SNP</a></div><div class="clearme"></div></div></div><div id="_toolbar-wrap"><div id="_toolbar"><div id="_toc-area" class="inactive"><a id="_toc-area-button" class="tool" title="Contents" accesskey="c" href="index.html"><span class="tool-spacer"><span class="toc-icon">Contents</span><span class="clearme"></span></span><span class="tool-label">Contents</span></a><div class="active-contents bubble-corner"></div><div class="active-contents bubble"><div class="bubble-container"><h6>Virtualization Guide</h6><div id="_bubble-toc"><ol><li class="inactive"><a href="cha-kvm.html"><span class="number"> </span><span class="name">Preface</span></a></li><li class="inactive"><a href="part-virt-intro.html"><span class="number">I </span><span class="name">Introduction</span></a><ol><li class="inactive"><a href="chap-virtualization-introduction.html"><span class="number">1 </span><span class="name">Virtualization technology</span></a></li><li class="inactive"><a href="cha-virtualization-scenarios.html"><span class="number">2 </span><span class="name">Virtualization scenarios</span></a></li><li class="inactive"><a href="cha-xen-basics.html"><span class="number">3 </span><span class="name">Introduction to Xen virtualization</span></a></li><li class="inactive"><a href="cha-kvm-intro.html"><span class="number">4 </span><span class="name">Introduction to KVM virtualization</span></a></li><li class="inactive"><a href="cha-tools-intro.html"><span class="number">5 </span><span class="name">Virtualization tools</span></a></li><li class="inactive"><a href="cha-vt-installation.html"><span class="number">6 </span><span class="name">Installation of virtualization components</span></a></li></ol></li><li class="inactive"><a href="part-virt-libvirt.html"><span class="number">II </span><span class="name">Managing virtual machines with <code class="systemitem">libvirt</code></span></a><ol><li class="inactive"><a href="cha-libvirt-overview.html"><span class="number">7 </span><span class="name"><code class="systemitem">libvirt</code> daemons</span></a></li><li class="inactive"><a href="cha-libvirt-host.html"><span class="number">8 </span><span class="name">Preparing the VM Host Server</span></a></li><li class="inactive"><a href="cha-kvm-inst.html"><span class="number">9 </span><span class="name">Guest installation</span></a></li><li class="inactive"><a href="cha-libvirt-managing.html"><span class="number">10 </span><span class="name">Basic VM Guest management</span></a></li><li class="inactive"><a href="cha-libvirt-connect.html"><span class="number">11 </span><span class="name">Connecting and authorizing</span></a></li><li class="inactive"><a href="cha-libvirt-storage.html"><span class="number">12 </span><span class="name">Advanced storage topics</span></a></li><li class="inactive"><a href="cha-libvirt-config-gui.html"><span class="number">13 </span><span class="name">Configuring virtual machines with Virtual Machine Manager</span></a></li><li class="inactive"><a href="cha-libvirt-config-virsh.html"><span class="number">14 </span><span class="name">Configuring virtual machines with <code class="command">virsh</code></span></a></li><li class="inactive"><a href="cha-vm-security.html"><span class="number">15 </span><span class="name">Enhancing virtual machine security with AMD SEV-SNP</span></a></li><li class="inactive"><a href="sec-libvirt-admin-migrate.html"><span class="number">16 </span><span class="name">Migrating VM Guests</span></a></li><li class="inactive"><a href="xen2kvm-migration.html"><span class="number">17 </span><span class="name">Xen to KVM migration guide</span></a></li></ol></li><li class="inactive"><a href="part-virt-common.html"><span class="number">III </span><span class="name">Hypervisor-independent features</span></a><ol><li class="inactive"><a href="cha-cachemodes.html"><span class="number">18 </span><span class="name">Disk cache modes</span></a></li><li class="inactive"><a href="sec-kvm-managing-clock.html"><span class="number">19 </span><span class="name">VM Guest clock settings</span></a></li><li class="inactive"><a href="chap-guestfs.html"><span class="number">20 </span><span class="name">libguestfs</span></a></li><li class="inactive"><a href="cha-qemu-ga.html"><span class="number">21 </span><span class="name">QEMU guest agent</span></a></li><li class="inactive"><a href="tpm.html"><span class="number">22 </span><span class="name">Software TPM emulator</span></a></li><li class="inactive"><a href="virt-crash-dump.html"><span class="number">23 </span><span class="name">Creating crash dumps of a VM Guest</span></a></li></ol></li><li class="inactive"><a href="part-virt-xen.html"><span class="number">IV </span><span class="name">Managing virtual machines with Xen</span></a><ol><li class="inactive"><a href="cha-xen-vhost.html"><span class="number">24 </span><span class="name">Setting up a virtual machine host</span></a></li><li class="inactive"><a href="cha-xen-network.html"><span class="number">25 </span><span class="name">Virtual networking</span></a></li><li class="inactive"><a href="cha-xen-manage.html"><span class="number">26 </span><span class="name">Managing a virtualization environment</span></a></li><li class="inactive"><a href="cha-xen-vbd.html"><span class="number">27 </span><span class="name">Block devices in Xen</span></a></li><li class="inactive"><a href="cha-xen-config.html"><span class="number">28 </span><span class="name">Virtualization: configuration options and settings</span></a></li><li class="inactive"><a href="cha-xen-admin.html"><span class="number">29 </span><span class="name">Administrative tasks</span></a></li><li class="inactive"><a href="cha-xen-xenstore.html"><span class="number">30 </span><span class="name">XenStore: configuration database shared between domains</span></a></li><li class="inactive"><a href="cha-xen-ha.html"><span class="number">31 </span><span class="name">Xen as a high-availability virtualization host</span></a></li><li class="inactive"><a href="pv-to-fv.html"><span class="number">32 </span><span class="name">Xen: converting a paravirtual (PV) guest into a fully virtual (FV/HVM) guest</span></a></li></ol></li><li class="inactive"><a href="part-virt-qemu.html"><span class="number">V </span><span class="name">Managing virtual machines with QEMU</span></a><ol><li class="inactive"><a href="cha-qemu-overview.html"><span class="number">33 </span><span class="name">QEMU overview</span></a></li><li class="inactive"><a href="cha-qemu-host.html"><span class="number">34 </span><span class="name">Setting up a KVM VM Host Server</span></a></li><li class="inactive"><a href="cha-qemu-guest-inst.html"><span class="number">35 </span><span class="name">Guest installation</span></a></li><li class="inactive"><a href="cha-qemu-running.html"><span class="number">36 </span><span class="name">Running virtual machines with qemu-system-ARCH</span></a></li><li class="inactive"><a href="cha-qemu-monitor.html"><span class="number">37 </span><span class="name">Virtual machine administration using QEMU monitor</span></a></li></ol></li><li class="inactive"><a href="part-virt-troubleshoot.html"><span class="number">VI </span><span class="name">Troubleshooting</span></a><ol><li class="inactive"><a href="cha-virt-help.html"><span class="number">38 </span><span class="name">Integrated help and package documentation</span></a></li><li class="inactive"><a href="cha-virt-logs.html"><span class="number">39 </span><span class="name">Gathering system information and logs</span></a></li></ol></li><li class="inactive"><a href="gloss-vt-glossary.html"><span class="number"> </span><span class="name">Glossary</span></a></li><li class="inactive"><a href="app-gpu-passthru.html"><span class="number">A </span><span class="name">Configuring GPU Pass-Through for NVIDIA cards</span></a></li><li class="inactive"><a href="bk06apb.html"><span class="number">B </span><span class="name">GNU licenses</span></a></li></ol></div><div class="clearme"></div></div></div></div><div id="_nav-area" class="inactive"><div class="tool"><span class="nav-inner"><span class="tool-label">Navigation</span><a accesskey="p" class="tool-spacer" title="Chapter 14. Configuring virtual machines with virsh" href="cha-libvirt-config-virsh.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 16. Migrating VM Guests" href="sec-libvirt-admin-migrate.html"><span class="next-icon">→</span></a></span></div></div></div></div><div id="_fixed-header-wrap" style="background-color: #E11;" class="inactive"><div id="_fixed-header"><div class="crumbs"><a class="book-link" href="index.html" title="Virtualization Guide"><span class="book-icon">Virtualization Guide</span></a><span> › </span><a class="crumb" href="part-virt-libvirt.html">Managing virtual machines with libvirt</a><span> › </span><a class="crumb" href="cha-vm-security.html">Enhancing virtual machine security with AMD SEV-SNP</a></div><div class="buttons"><a class="top-button button" href="#">Top</a><div class="button"><a accesskey="p" class="tool-spacer" title="Chapter 14. Configuring virtual machines with virsh" href="cha-libvirt-config-virsh.html"><span class="prev-icon">←</span></a><a accesskey="n" class="tool-spacer" title="Chapter 16. Migrating VM Guests" href="sec-libvirt-admin-migrate.html"><span class="next-icon">→</span></a></div><div class="clearme"></div></div><div class="clearme"></div></div></div><div id="_content" class="draft "><div class="documentation"><div class="chapter " id="cha-vm-security"><div class="titlepage"><div><div class="version-info">Applies to  <span class="productname "><span class="productname"><span class="phrase">openSUSE Leap</span></span></span> <span class="productnumber "><span class="productnumber"><span class="phrase">15.6</span></span></span></div><div><h2 class="title"><span class="number">15 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Enhancing virtual machine security with AMD SEV-SNP</span> <a title="Permalink" class="permalink" href="cha-vm-security.html#">#</a><a class="report-bug" rel="nofollow" target="_blank" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit the source file for this section">Edit source</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>vm_security.xml</li><li><span class="ds-label">ID: </span>cha-vm-security</li></ul></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="cha-vm-security.html#id-1.8.4.10.2.1">#</a></h6></div><p>You can enhance the security of your virtual machines with AMD Secure Encrypted Virtualization-Secure Nested Paging (SEV-SNP). The AMD SEV-SNP feature isolates virtual machines from the host system and other VMs, protecting the data and code. This feature encrypts data and ensures that all changes with the code and data in the VM are detected or tracked. Since this isolates VMs, the other VMs or the host machine are not affected with threats.</p><p>This section explains the steps to enable and use AMD SEV-SNP on your AMD EPYC server with <span class="productname"><span class="phrase">openSUSE Leap</span></span> <span class="productnumber"><span class="phrase">15.6</span></span>.</p></div></div><div><div class="abstract"><div class="abstract-title-wrap"><h6 class="abstract-title">Abstract<a title="Permalink" class="permalink" href="cha-vm-security.html#id-1.8.4.10.2.2">#</a></h6></div><div id="id-1.8.4.10.2.2.1" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg" /><h6>Note: Technology preview for <span class="productname"><span class="phrase">openSUSE Leap</span></span> 15 SP6</h6><p>
This feature is shipped as a technology preview in <span class="productname"><span class="phrase">openSUSE Leap</span></span> 15 SP6. The necessary packages are not part of the default installation or repositories. These packages are shipped via a confidential compute module.
</p></div></div></div></div></div><div class="line"><div class="toc"><dl><dt><span class="sect1"><a href="cha-vm-security.html#vm-security-hardware-support"><span class="number">15.1 </span><span class="name">Supported hardware</span></a></span></dt><dt><span class="sect1"><a href="cha-vm-security.html#vm-security-enable-confidential-compute-module"><span class="number">15.2 </span><span class="name">Enabling confidential compute module</span></a></span></dt><dt><span class="sect1"><a href="cha-vm-security.html#vm-security-verify-setup"><span class="number">15.3 </span><span class="name">Installing packages and setting up the base system</span></a></span></dt><dt><span class="sect1"><a href="cha-vm-security.html#vm-verify-setup"><span class="number">15.4 </span><span class="name">Verifying setup</span></a></span></dt><dt><span class="sect1"><a href="cha-vm-security.html#vm-launch-amd-sv-snp-vm"><span class="number">15.5 </span><span class="name">Launching an AMD SEV-SNP virtual machine</span></a></span></dt><dt><span class="sect1"><a href="cha-vm-security.html#vm-verify-amd-sv-snp-vm"><span class="number">15.6 </span><span class="name">Verifying the AMD SEV-SNP virtual machine</span></a></span></dt></dl></div></div><div class="sect1 " id="vm-security-hardware-support"><div class="titlepage"><div><div><h2 class="title"><span class="number">15.1 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Supported hardware</span> <a title="Permalink" class="permalink" href="cha-vm-security.html#vm-security-hardware-support">#</a><a class="report-bug" rel="nofollow" target="_blank" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit the source file for this section">Edit source</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>vm_security.xml</li><li><span class="ds-label">ID: </span>vm-security-hardware-support</li></ul></div></div></div></div><p>
A system with an AMD EPYC (3rd Gen or newer) is required to run AMD SEV-SNP virtual machines. The BIOS of the AMD machine must provide the necessary options to enable support for confidential computing on the platform.</p></div><div class="sect1 " id="vm-security-enable-confidential-compute-module"><div class="titlepage"><div><div><h2 class="title"><span class="number">15.2 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Enabling confidential compute module</span> <a title="Permalink" class="permalink" href="cha-vm-security.html#vm-security-enable-confidential-compute-module">#</a><a class="report-bug" rel="nofollow" target="_blank" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit the source file for this section">Edit source</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>vm_security.xml</li><li><span class="ds-label">ID: </span>vm-security-enable-confidential-compute-module</li></ul></div></div></div></div><p>The necessary packages for AMD SEV-SNP feature are shipped via a confidential compute module. You must enable it at system installation time or later via the SUSEConnect command-line tool.</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>To check whether the module is already enabled, run the command:
</p><div class="verbatim-wrap"><pre class="screen"> <code class="prompt user">&gt; </code><code class="command">sudo</code>  suseconnect -l</pre></div><p>This displays the list of available modules with their activation status and commands to enable the inactive modules.</p><p>The inactive confidential compute module appears as given below:</p><div class="verbatim-wrap"><pre class="screen">Confidential Computing Technical Preview Module 15 SP6 x86_64
Activate with: suseconnect -p sle-module-confidential-computing/15.6/x86_64</pre></div></li><li class="listitem "><p>To enable the confidential computing module technology preview, run the command:</p><div class="verbatim-wrap"><pre class="screen"> <code class="prompt user">&gt; </code><code class="command">sudo</code>  <code class="command">suseconnect -p sle-module-confidential-computing/15.6/x86_64</code>
Registering system to SUSE Customer Center
Updating system details on https://scc.suse.com ...
Activating sle-module-confidential-computing 15.6 x86_64 ...
Adding service to system ...
Installing release package ...
Successfully registered system</pre></div><p>The confidential compute module is enabled and you can install the packages.</p></li></ul></div></div><div class="sect1 " id="vm-security-verify-setup"><div class="titlepage"><div><div><h2 class="title"><span class="number">15.3 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Installing packages and setting up the base system</span> <a title="Permalink" class="permalink" href="cha-vm-security.html#vm-security-verify-setup">#</a><a class="report-bug" rel="nofollow" target="_blank" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit the source file for this section">Edit source</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>vm_security.xml</li><li><span class="ds-label">ID: </span>vm-security-verify-setup</li></ul></div></div></div></div><p>
The confidential compute module provides replacement packages supporting AMD SEV-SNP. To ensure a maximum of compatibility, these packages are based on the code streams from <span class="productname"><span class="phrase">openSUSE Leap</span></span> <span class="productnumber"><span class="phrase">15.6</span></span>.</p><p>The three components that need to be replaced are:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>The Linux kernel</p></li><li class="listitem "><p>QEMU Virtual Machine Monitor</p></li><li class="listitem "><p><code class="systemitem">libvirt</code> framework</p></li></ul></div><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>To install the replacement packages, run the command:</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code>  <code class="command">zypper install --from SLE-Module-Confidential-Computing-15-SP6-Pool --from SLE-Module-Confidential-Computing-15-SP6-Updates qemu libvirt kernel-coco</code></pre></div><p>After replacing the packages, you must set up the system with a configuration change to make the AMD SEV-SNP feature ready to use. The IOMMU on the host side must be configured in non-passthrough mode. This is required to prevent peripheral devices from writing to memory that belongs to an encrypted guest and destroying its data integrity. The default IOMMU configuration in <span class="productname"><span class="phrase">openSUSE Leap</span></span> <span class="productnumber"><span class="phrase">15.6</span></span> is <code class="literal">passthrough</code> mode.</p></li><li class="step "><p>To disable the IOMMU configuration in <span class="productname"><span class="phrase">openSUSE Leap</span></span> <span class="productnumber"><span class="phrase">15.6</span></span>, open the <code class="filename">/etc/default/grub</code> file and add <code class="literal">iommu=nopt</code> to the <code class="varname">GRUB_CMDLINE_LINUX_DEFAULT</code> variable. </p></li><li class="step "><p>To update the bootloader configuration, run the command:</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code> ; <code class="command">update-bootloader</code></pre></div></li><li class="step "><p>The system is now ready to be restarted with the confidential computing kernel. It is not selected as the default kernel in the bootloader, so ensure to select it in the boot menu.</p></li></ol></div></div></div><div class="sect1 " id="vm-verify-setup"><div class="titlepage"><div><div><h2 class="title"><span class="number">15.4 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Verifying setup</span> <a title="Permalink" class="permalink" href="cha-vm-security.html#vm-verify-setup">#</a><a class="report-bug" rel="nofollow" target="_blank" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit the source file for this section">Edit source</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>vm_security.xml</li><li><span class="ds-label">ID: </span>vm-verify-setup</li></ul></div></div></div></div><p>You can verify the installation and configuration of the packages.</p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>To verify whether the system has started with the new kernel, check the response for the command <code class="command">uname -r</code>.</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code>  <code class="command">uname -r</code> <em class="replaceable ">6.4.0-150616.coco15sp6-coco</em></pre></div><p>Ensure that the kernel version displayed contains the coco tag.</p></li><li class="step "><p>To check the initialization result of the AMD Secure Processor in the kernel log when the kernel is running, run the command:</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code>  <code class="command">dmesg | grep -i ccp</code>
[ 10.103166] ccp 0000:42:00.1: enabling device (0000 -&gt; 0002)
[ 10.114951] ccp 0000:42:00.1: no command queues available
[ 10.127137] ccp 0000:42:00.1: sev enabled
[ 10.133152] ccp 0000:42:00.1: psp enabled
[ 10.240817] ccp 0000:42:00.1: SEV firmware update successful
[ 11.128307] ccp 0000:42:00.1: SEV API:1.55 build:8
[ 11.135057] ccp 0000:42:00.1: SEV-SNP API:1.55 build:8</pre></div><p>The message about the SEV-SNP API version indicates the successful initialization of the AMD Secure Processor. Sometimes it happens that these messages do not appear in the kernel log. In this case the BIOS settings or the IOMMU configuration are often the root-cause.</p></li></ol></div></div></div><div class="sect1 " id="vm-launch-amd-sv-snp-vm"><div class="titlepage"><div><div><h2 class="title"><span class="number">15.5 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Launching an AMD SEV-SNP virtual machine</span> <a title="Permalink" class="permalink" href="cha-vm-security.html#vm-launch-amd-sv-snp-vm">#</a><a class="report-bug" rel="nofollow" target="_blank" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit the source file for this section">Edit source</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>vm_security.xml</li><li><span class="ds-label">ID: </span>vm-launch-amd-sv-snp-vm</li></ul></div></div></div></div><p>
You can run AMD SEV-SNP protected virtual machines using the <code class="systemitem">libvirt</code> framework once the confidential computing kernel is booted and the AMD Secure Processor is initialized.</p><p><code class="systemitem">libvirt</code> has several ways of setting up new virtual machines. This document uses a prepared disk image and the virt-manager graphical user interface.</p><div class="procedure "><div class="procedure-contents"><ol class="procedure" type="1"><li class="step "><p>Connect virt-manager to the AMD EPYC host and create a new virtual machine.</p></li><li class="step "><p>In the Create a new virtual machine window, select the details:</p><div class="itemizedlist "><ul class="itemizedlist"><li class="listitem "><p>Select how you want to install the operating system.</p></li><li class="listitem "><p>Select the ISO or CDROM install media.</p></li><li class="listitem "><p>Select the memory and CPU settings.</p></li><li class="listitem "><p>Select the required storage details.</p></li></ul></div></li><li class="step "><p>In the fifth step, verify the details and select <span class="guilabel ">Customize configuration before install</span>.</p><div class="figure" id="id-1.8.4.10.7.4.3.2"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/vm_security_create_vm.png" target="_blank"><img src="images/vm_security_create_vm.png" width="" alt="Select Customize configuration before install" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 15.1: </span><span class="name">Create Virtual Machine </span><a title="Permalink" class="permalink" href="cha-vm-security.html#id-1.8.4.10.7.4.3.2">#</a></h6></div></div></li><li class="step "><p>Click <span class="guilabel ">Finish</span>.</p></li><li class="step "><p>Select the XML tab in the virtual machine configuration window.</p><p>In the XML tab, you can edit the XML configuration of the virtual machine used by the <code class="systemitem">libvirt</code> back-end.</p><div class="figure" id="id-1.8.4.10.7.4.5.3"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/vm_security_create_vm_xml.png" target="_blank"><img src="images/vm_security_create_vm_xml.png" width="" alt="Click XML tab" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 15.2: </span><span class="name"><span class="guimenu ">XML</span> view of virtual machine configuration </span><a title="Permalink" class="permalink" href="cha-vm-security.html#id-1.8.4.10.7.4.5.3">#</a></h6></div></div></li><li class="step "><p>
To protect the virtual machine with AMD SEV-SNP, set the correct firmware by modifying the <code class="literal">os</code> section as given below:</p><div class="figure" id="id-1.8.4.10.7.4.6.2"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/vm_security_xml_os.png" target="_blank"><img src="images/vm_security_xml_os.png" width="" alt="Set firmware" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 15.3: </span><span class="name">Set firmware </span><a title="Permalink" class="permalink" href="cha-vm-security.html#id-1.8.4.10.7.4.6.2">#</a></h6></div></div><p>The <code class="literal">loader</code> line sets the firmware to the SEV version of OVMF.</p></li><li class="step "><p>Add a <code class="literal">launchSecurity</code> section. For AMD SEV-SNP, the section looks like this:</p><div class="figure" id="id-1.8.4.10.7.4.7.2"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/vm_security_xml_launchsecurity.png" target="_blank"><img src="images/vm_security_xml_launchsecurity.png" width="" alt="Add launchSecurity" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 15.4: </span><span class="name">launchSecurity </span><a title="Permalink" class="permalink" href="cha-vm-security.html#id-1.8.4.10.7.4.7.2">#</a></h6></div></div></li><li class="step "><p>Click <span class="guilabel ">Apply</span> and then click the <span class="guilabel ">Details</span> tab.</p></li><li class="step "><p>Select CPUs in the left-hand list and set the CPU <span class="guilabel ">Model</span> to <code class="literal">host-model</code>:</p><div class="figure" id="id-1.8.4.10.7.4.9.2"><div class="figure-contents"><div class="mediaobject"><a xmlns="" href="images/vm_security_create_vm_details.png" target="_blank"><img src="images/vm_security_create_vm_details.png" width="" alt="Select CPU model" /></a></div></div><div class="figure-title-wrap"><h6 class="figure-title"><span class="number">Figure 15.5: </span><span class="name">The <span class="guimenu ">Details</span> view of virtual machine configuration </span><a title="Permalink" class="permalink" href="cha-vm-security.html#id-1.8.4.10.7.4.9.2">#</a></h6></div></div></li><li class="step "><p>Click <span class="guilabel ">Apply</span> and click <span class="guilabel ">Begin Installation</span>.</p><p>This starts the virtual machine and installs it according to your settings. The virtual machine boots up once the process is complete, and you can verify the AMD SEV-SNP protection.</p></li></ol></div></div></div><div class="sect1 " id="vm-verify-amd-sv-snp-vm"><div class="titlepage"><div><div><h2 class="title"><span class="number">15.6 </span><span xmlns:dm="urn:x-suse:ns:docmanager" class="name">Verifying the AMD SEV-SNP virtual machine</span> <a title="Permalink" class="permalink" href="cha-vm-security.html#vm-verify-amd-sv-snp-vm">#</a><a class="report-bug" rel="nofollow" target="_blank" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit the source file for this section">Edit source</a></h2><div class="doc-status"><ul><li><span class="ds-label">File Name: </span>vm_security.xml</li><li><span class="ds-label">ID: </span>vm-verify-amd-sv-snp-vm</li></ul></div></div></div></div><p>
From the appearance of the virtual machine, one cannot tell whether it runs in a confidential computing environment. But there are several ways to verify that from within the virtual machine.</p><p>To check the kernel log, run the command:</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code>  <code class="command">dmesg | grep -i sev-snp</code>
[ 1.986186] Memory Encryption Features active: AMD SEV SEV-ES SEV-SNP</pre></div><p>The presence of the SEV-SNP feature in the kernel log, among other active 
memory encryption features, shows that it is active for the virtual machine.</p><p>There are also cryptographically secure ways to prove the security of the AMD SEV-SNP environment.
</p></div></div></div><div class="page-bottom"><div id="_bottom-navigation"><a class="nav-link" href="sec-libvirt-admin-migrate.html"><span class="next-icon">→</span><span class="nav-label"><span class="number">Chapter 16 </span>Migrating VM Guests</span></a><a class="nav-link" href="cha-libvirt-config-virsh.html"><span class="prev-icon">←</span><span class="nav-label"><span class="number">Chapter 14 </span>Configuring virtual machines with <code class="command">virsh</code></span></a></div><div class="_share-print"><div class="online-contents share"><strong>Share this page: </strong><span class="share-buttons"><span class="_share-fb bottom-button">Facebook</span><span class="spacer"> • </span><span class="_share-in bottom-button">LinkedIn</span><span class="spacer"> • </span><span class="_share-tw bottom-button">Twitter</span><span class="spacer"> • </span><span class="_share-mail bottom-button">E-Mail</span></span></div><div class="print"><span class="_print-button bottom-button">Print this page</span></div><div class="clearme"></div></div></div></div><div id="_inward"></div></div><div id="_footer-wrap"><div id="_footer"><p>©
        2024 
        SUSE</p><ul><li><a href="https://jobs.suse.com/" target="_top">Careers</a></li><li><a href="https://www.suse.com/company/legal/" target="_top">Legal</a></li><li><a href="https://www.suse.com/company/about/" target="_top">About</a></li><li><a href="https://www.suse.com/contact/" target="_top">Contact Us</a></li></ul></div></div></body></html>