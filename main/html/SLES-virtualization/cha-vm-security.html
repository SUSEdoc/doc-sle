<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><title>SLES 15 SP6 | Virtualization Guide | Enhancing virtual machine security with AMD SEV-SNP</title><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes"/><link rel="stylesheet" type="text/css" href="static/css/style.css"/>
<link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"/><link rel="schema.DCTERMS" href="http://purl.org/dc/terms/"/>
<meta name="title" content="Enhancing virtual machine security with AMD SEV-SNP | …"/>
<meta name="description" content="You can enhance the security of your virtual machines with AMD Secure Encrypted Virtualization-Secure Nested Paging (SEV-SNP). The AMD SEV-SNP featur…"/>
<meta name="product-name" content="SUSE Linux Enterprise Server"/>
<meta name="product-number" content="15 SP6"/>
<meta name="book-title" content="Virtualization Guide"/>
<meta name="chapter-title" content="Chapter 16. Enhancing virtual machine security with AMD SEV-SNP"/>
<meta name="tracker-url" content="https://bugzilla.suse.com/enter_bug.cgi"/>
<meta name="tracker-type" content="bsc"/>
<meta name="tracker-bsc-assignee" content="fs@suse.com"/>
<meta name="tracker-bsc-component" content="Documentation"/>
<meta name="tracker-bsc-product" content="PUBLIC SUSE Linux Enterprise Server 15 SP6"/>
<meta name="publisher" content="SUSE"/><meta property="og:title" content="Virtualization Guide"/>
<meta property="og:description" content="Learn all about virtualization and VM management"/>
<meta property="og:type" content="article"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Virtualization Guide"/>
<meta name="twitter:description" content="Learn all about virtualization and VM management"/>
<script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": ["TechArticle"],
    "image": "https://www.suse.com/assets/img/suse-white-logo-green.svg",
    
     "isPartOf": {
      "@type": "CreativeWorkSeries",
      "name": "Products &amp; Solutions"
    },
    
    "inLanguage": "en",
    

    "headline": "Enhancing virtual machine security with AMD SEV-SNP",
  
    "description": "You can enhance the security of your virtual machines with AMD Secure Encrypted Virtualization-Secure Nested Paging (SEV-SNP). The AMD SEV-SNP featur…",
      
    "author": [
      {
        "@type": "Corporation",
        "name": "SUSE Product &amp; Solution Documentation Team",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    ],
      
    "dateModified": "2024-06-26T00:00+02:00",
      
    "datePublished": "2024-06-26T00:00+02:00",
      

    "about": [
      
    ],
  
    "sameAs": [
          "https://www.facebook.com/SUSEWorldwide/about",
          "https://www.youtube.com/channel/UCHTfqIzPKz4f_dri36lAQGA",
          "https://twitter.com/SUSE",
          "https://www.linkedin.com/company/suse"
    ],
    "publisher": {
      "@type": "Corporation",
      "name": "SUSE",
      "url": "https://documentation.suse.com",
      "logo": {
        "@type": "ImageObject",
        "url": "https://www.suse.com/assets/img/suse-white-logo-green.svg"
      }
    }
  }</script>
<link rel="prev" href="cha-libvirt-config-virsh.html" title="Chapter 15. Configuring virtual machines with virsh"/><link rel="next" href="sec-libvirt-admin-migrate.html" title="Chapter 17. Migrating VM Guests"/><script type="text/javascript">

if ( window.location.protocol.toLowerCase() != 'file:' ) {
  document.write('<link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"></link>');
};

</script><noscript><link rel="stylesheet" type="text/css" href="https://documentation.suse.com/docserv/res/fonts/poppins/poppins.css"/></noscript><script src="static/js/script-purejs.js" type="text/javascript"> </script><script src="static/js/highlight.min.js" type="text/javascript"> </script><script>

$(document).ready(function() {
  $('.verbatim-wrap.highlight').each(function(i, block) {
    hljs.highlightBlock(block);
  });
});
hljs.configure({
  useBR: false
});

</script><meta name="edit-url" content="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml"/></head><body class="draft wide offline js-off" onload="$('#betawarn-button-wrap').toggle();if (document.cookie.length > 0) {if (document.cookie.indexOf('betawarn=closed') != -1){$('#betawarn').toggle()}};"><div id="betawarn" style="position:fixed;bottom:0;z-index:9025;background-color:#FDE8E8;padding:1em;margin-left:10%;margin-right:10%;display:block;border-top:.75em solid #E11;width:80%"><p style="color:#333;margin:1em 0;padding:0;">This is a draft document that was built and uploaded automatically. It may document beta software and be incomplete or even incorrect. <strong>Use this document at your own risk.</strong></p> <div id="betawarn-button-wrap" style="display:none;margin:0;padding:0;"><a href="#" onclick="$('#betawarn').toggle();var d=new Date();d.setTime(d.getTime()+(0.5*24*60*60*1000));document.cookie='betawarn=closed; expires='+d.toUTCString()+'; path=/'; return false;" style="color:#333;text-decoration:underline;float:left;margin-top:.5em;padding:1em;display:block;background-color:#FABEBE;">I understand this is a draft</a></div></div><div class="bypass-block"><a href="#_content">Jump to content</a><a href="#_bottom-pagination">Jump to page navigation: previous page [access key p]/next page [access key n]</a></div><header id="_mainnav"><div class="growth-inhibitor"><img src="static/images/logo.svg" alt="Logo" class="logo"/></div></header><div class="crumbs"><div class="growth-inhibitor"><a class="crumb" href="index.html">Virtualization Guide</a><span> / </span><a class="crumb" href="part-virt-libvirt.html">Managing virtual machines with libvirt</a><span> / </span><a class="crumb" href="cha-vm-security.html">Enhancing virtual machine security with AMD SEV-SNP</a></div></div><main id="_content"><nav id="_side-toc-overall" class="side-toc"><div class="side-title">Virtualization Guide</div><ol><li><a href="cha-kvm.html" class=" "><span class="title-number"> </span><span class="title-name">Preface</span></a></li><li><a href="part-virt-intro.html" class="has-children "><span class="title-number">I </span><span class="title-name">Introduction</span></a><ol><li><a href="chap-virtualization-introduction.html" class=" "><span class="title-number">1 </span><span class="title-name">Virtualization technology</span></a></li><li><a href="cha-virtualization-scenarios.html" class=" "><span class="title-number">2 </span><span class="title-name">Virtualization scenarios</span></a></li><li><a href="cha-xen-basics.html" class=" "><span class="title-number">3 </span><span class="title-name">Introduction to Xen virtualization</span></a></li><li><a href="cha-kvm-intro.html" class=" "><span class="title-number">4 </span><span class="title-name">Introduction to KVM virtualization</span></a></li><li><a href="cha-tools-intro.html" class=" "><span class="title-number">5 </span><span class="title-name">Virtualization tools</span></a></li><li><a href="cha-vt-installation.html" class=" "><span class="title-number">6 </span><span class="title-name">Installation of virtualization components</span></a></li><li><a href="cha-virt-support.html" class=" "><span class="title-number">7 </span><span class="title-name">Virtualization limits and support</span></a></li></ol></li><li class="active"><a href="part-virt-libvirt.html" class="has-children you-are-here"><span class="title-number">II </span><span class="title-name">Managing virtual machines with <code class="systemitem">libvirt</code></span></a><ol><li><a href="cha-libvirt-overview.html" class=" "><span class="title-number">8 </span><span class="title-name"><code class="systemitem">libvirt</code> daemons</span></a></li><li><a href="cha-libvirt-host.html" class=" "><span class="title-number">9 </span><span class="title-name">Preparing the VM Host Server</span></a></li><li><a href="cha-kvm-inst.html" class=" "><span class="title-number">10 </span><span class="title-name">Guest installation</span></a></li><li><a href="cha-libvirt-managing.html" class=" "><span class="title-number">11 </span><span class="title-name">Basic VM Guest management</span></a></li><li><a href="cha-libvirt-connect.html" class=" "><span class="title-number">12 </span><span class="title-name">Connecting and authorizing</span></a></li><li><a href="cha-libvirt-storage.html" class=" "><span class="title-number">13 </span><span class="title-name">Advanced storage topics</span></a></li><li><a href="cha-libvirt-config-gui.html" class=" "><span class="title-number">14 </span><span class="title-name">Configuring virtual machines with Virtual Machine Manager</span></a></li><li><a href="cha-libvirt-config-virsh.html" class=" "><span class="title-number">15 </span><span class="title-name">Configuring virtual machines with <code class="command">virsh</code></span></a></li><li><a href="cha-vm-security.html" class=" you-are-here"><span class="title-number">16 </span><span class="title-name">Enhancing virtual machine security with AMD SEV-SNP</span></a></li><li><a href="sec-libvirt-admin-migrate.html" class=" "><span class="title-number">17 </span><span class="title-name">Migrating VM Guests</span></a></li><li><a href="xen2kvm-migration.html" class=" "><span class="title-number">18 </span><span class="title-name">Xen to KVM migration guide</span></a></li></ol></li><li><a href="part-virt-common.html" class="has-children "><span class="title-number">III </span><span class="title-name">Hypervisor-independent features</span></a><ol><li><a href="cha-cachemodes.html" class=" "><span class="title-number">19 </span><span class="title-name">Disk cache modes</span></a></li><li><a href="sec-kvm-managing-clock.html" class=" "><span class="title-number">20 </span><span class="title-name">VM Guest clock settings</span></a></li><li><a href="chap-guestfs.html" class=" "><span class="title-number">21 </span><span class="title-name">libguestfs</span></a></li><li><a href="cha-qemu-ga.html" class=" "><span class="title-number">22 </span><span class="title-name">QEMU guest agent</span></a></li><li><a href="tpm.html" class=" "><span class="title-number">23 </span><span class="title-name">Software TPM emulator</span></a></li><li><a href="virt-crash-dump.html" class=" "><span class="title-number">24 </span><span class="title-name">Creating crash dumps of a VM Guest</span></a></li></ol></li><li><a href="part-virt-xen.html" class="has-children "><span class="title-number">IV </span><span class="title-name">Managing virtual machines with Xen</span></a><ol><li><a href="cha-xen-vhost.html" class=" "><span class="title-number">25 </span><span class="title-name">Setting up a virtual machine host</span></a></li><li><a href="cha-xen-network.html" class=" "><span class="title-number">26 </span><span class="title-name">Virtual networking</span></a></li><li><a href="cha-xen-manage.html" class=" "><span class="title-number">27 </span><span class="title-name">Managing a virtualization environment</span></a></li><li><a href="cha-xen-vbd.html" class=" "><span class="title-number">28 </span><span class="title-name">Block devices in Xen</span></a></li><li><a href="cha-xen-config.html" class=" "><span class="title-number">29 </span><span class="title-name">Virtualization: configuration options and settings</span></a></li><li><a href="cha-xen-admin.html" class=" "><span class="title-number">30 </span><span class="title-name">Administrative tasks</span></a></li><li><a href="cha-xen-xenstore.html" class=" "><span class="title-number">31 </span><span class="title-name">XenStore: configuration database shared between domains</span></a></li><li><a href="cha-xen-ha.html" class=" "><span class="title-number">32 </span><span class="title-name">Xen as a high-availability virtualization host</span></a></li><li><a href="pv-to-fv.html" class=" "><span class="title-number">33 </span><span class="title-name">Xen: converting a paravirtual (PV) guest into a fully virtual (FV/HVM) guest</span></a></li></ol></li><li><a href="part-virt-qemu.html" class="has-children "><span class="title-number">V </span><span class="title-name">Managing virtual machines with QEMU</span></a><ol><li><a href="cha-qemu-overview.html" class=" "><span class="title-number">34 </span><span class="title-name">QEMU overview</span></a></li><li><a href="cha-qemu-host.html" class=" "><span class="title-number">35 </span><span class="title-name">Setting up a KVM VM Host Server</span></a></li><li><a href="cha-qemu-guest-inst.html" class=" "><span class="title-number">36 </span><span class="title-name">Guest installation</span></a></li><li><a href="cha-qemu-running.html" class=" "><span class="title-number">37 </span><span class="title-name">Running virtual machines with qemu-system-ARCH</span></a></li><li><a href="cha-qemu-monitor.html" class=" "><span class="title-number">38 </span><span class="title-name">Virtual machine administration using QEMU monitor</span></a></li></ol></li><li><a href="part-virt-troubleshoot.html" class="has-children "><span class="title-number">VI </span><span class="title-name">Troubleshooting</span></a><ol><li><a href="cha-virt-help.html" class=" "><span class="title-number">39 </span><span class="title-name">Integrated help and package documentation</span></a></li><li><a href="cha-virt-logs.html" class=" "><span class="title-number">40 </span><span class="title-name">Gathering system information and logs</span></a></li></ol></li><li><a href="gloss-vt-glossary.html" class=" "><span class="title-number"> </span><span class="title-name">Glossary</span></a></li><li><a href="app-vmdp-driver.html" class=" "><span class="title-number">A </span><span class="title-name">Virtual machine drivers</span></a></li><li><a href="app-gpu-passthru.html" class=" "><span class="title-number">B </span><span class="title-name">Configuring GPU Pass-Through for NVIDIA cards</span></a></li><li><a href="cha-xmtoxl.html" class=" "><span class="title-number">C </span><span class="title-name">XM, XL toolstacks, and the <code class="systemitem">libvirt</code> framework</span></a></li><li><a href="bk10apd.html" class=" "><span class="title-number">D </span><span class="title-name">GNU licenses</span></a></li> </ol> </nav><button id="_open-side-toc-overall" title="Contents"> </button><article class="documentation"><button id="_unfold-side-toc-page">On this page</button><section class="chapter" id="cha-vm-security" data-id-title="Enhancing virtual machine security with AMD SEV-SNP"><div class="titlepage"><div><div class="version-info">Applies to  <span class="productname"><span class="productname"><span class="phrase">SUSE Linux Enterprise Server</span></span></span> <span class="productnumber"><span class="productnumber"><span class="phrase">15 SP6</span></span></span></div><div><div class="title-container"><h1 class="title"><span class="title-number-name"><span class="title-number">16 </span><span class="title-name">Enhancing virtual machine security with AMD SEV-SNP</span></span> <a title="Permalink" class="permalink" href="cha-vm-security.html#">#</a></h1><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit source document"> </a></div></div></div><div><div class="abstract"><p>You can enhance the security of your virtual machines with AMD Secure Encrypted Virtualization-Secure Nested Paging (SEV-SNP). The AMD SEV-SNP feature isolates virtual machines from the host system and other VMs, protecting the data and code. This feature encrypts data and ensures that all changes with the code and data in the VM are detected or tracked. Since this isolates VMs, the other VMs or the host machine are not affected with threats.</p><p>This section explains the steps to enable and use AMD SEV-SNP on your AMD EPYC server with <span class="productname"><span class="phrase">SUSE Linux Enterprise Server</span></span> <span class="productnumber"><span class="phrase">15 SP6</span></span>.</p></div></div><div><div class="abstract"><div id="id-1.12.4.10.2.2.1" data-id-title="Technology preview for SUSE Linux Enterprise Server 15 SP6" class="admonition note normal"><img class="symbol" alt="Note" title="Note" src="static/images/icon-note.svg"/><div class="admon-title">Note: Technology preview for <span class="productname"><span class="phrase">SUSE Linux Enterprise Server</span></span> 15 SP6</div><p>
This feature is shipped as a technology preview in <span class="productname"><span class="phrase">SUSE Linux Enterprise Server</span></span> 15 SP6. The necessary packages are not part of the default installation or repositories. These packages are shipped via a confidential compute module.
</p></div></div></div></div></div><section class="sect1" id="vm-security-hardware-support" data-id-title="Supported hardware"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">16.1 </span><span class="title-name">Supported hardware</span></span> <a title="Permalink" class="permalink" href="cha-vm-security.html#vm-security-hardware-support">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit source document"> </a></div></div></div></div></div><p>
A system with an AMD EPYC (3rd Gen or newer) is required to run AMD SEV-SNP virtual machines. The BIOS of the AMD machine must provide the necessary options to enable support for confidential computing on the platform.</p></section><section class="sect1" id="vm-security-enable-confidential-compute-module" data-id-title="Enabling confidential compute module"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">16.2 </span><span class="title-name">Enabling confidential compute module</span></span> <a title="Permalink" class="permalink" href="cha-vm-security.html#vm-security-enable-confidential-compute-module">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit source document"> </a></div></div></div></div></div><p>The necessary packages for AMD SEV-SNP feature are shipped via a confidential compute module. You must enable it at system installation time or later via the SUSEConnect command-line tool.</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>To check whether the module is already enabled, run the command:
</p><div class="verbatim-wrap"><pre class="screen"> <code class="prompt user">&gt; </code><code class="command">sudo</code>  suseconnect -l</pre></div><p>This displays the list of available modules with their activation status and commands to enable the inactive modules.</p><p>The inactive confidential compute module appears as given below:</p><div class="verbatim-wrap"><pre class="screen">Confidential Computing Technical Preview Module 15 SP6 x86_64
Activate with: suseconnect -p sle-module-confidential-computing/15.6/x86_64</pre></div></li><li class="listitem"><p>To enable the confidential computing module technology preview, run the command:</p><div class="verbatim-wrap"><pre class="screen"> <code class="prompt user">&gt; </code><code class="command">sudo</code>  <code class="command">suseconnect -p sle-module-confidential-computing/15.6/x86_64</code>
Registering system to SUSE Customer Center
Updating system details on https://scc.suse.com ...
Activating sle-module-confidential-computing 15.6 x86_64 ...
Adding service to system ...
Installing release package ...
Successfully registered system</pre></div><p>The confidential compute module is enabled and you can install the packages.</p></li></ul></div></section><section class="sect1" id="vm-security-verify-setup" data-id-title="Installing packages and setting up the base system"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">16.3 </span><span class="title-name">Installing packages and setting up the base system</span></span> <a title="Permalink" class="permalink" href="cha-vm-security.html#vm-security-verify-setup">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit source document"> </a></div></div></div></div></div><p>
The confidential compute module provides replacement packages supporting AMD SEV-SNP. To ensure a maximum of compatibility, these packages are based on the code streams from <span class="productname"><span class="phrase">SUSE Linux Enterprise Server</span></span> <span class="productnumber"><span class="phrase">15 SP6</span></span>.</p><p>The three components that need to be replaced are:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>The Linux kernel</p></li><li class="listitem"><p>QEMU Virtual Machine Monitor</p></li><li class="listitem"><p><code class="systemitem">libvirt</code> framework</p></li></ul></div><div class="procedure"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>To install the replacement packages, run the command:</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code>  <code class="command">zypper install --from SLE-Module-Confidential-Computing-15-SP6-Pool --from SLE-Module-Confidential-Computing-15-SP6-Updates qemu-ovmf-x86_64 libvirt kernel-coco</code></pre></div><p>After replacing the packages, you must set up the system with a configuration change to make the AMD SEV-SNP feature ready to use. The IOMMU on the host side must be configured in non-passthrough mode. This is required to prevent peripheral devices from writing to memory that belongs to an encrypted guest and destroying its data integrity. The default IOMMU configuration in <span class="productname"><span class="phrase">SUSE Linux Enterprise Server</span></span> <span class="productnumber"><span class="phrase">15 SP6</span></span> is <code class="literal">passthrough</code> mode.</p></li><li class="step"><p>To disable the IOMMU configuration in <span class="productname"><span class="phrase">SUSE Linux Enterprise Server</span></span> <span class="productnumber"><span class="phrase">15 SP6</span></span>, open the <code class="filename">/etc/default/grub</code> file and add <code class="literal">iommu=nopt</code> to the <code class="varname">GRUB_CMDLINE_LINUX_DEFAULT</code> variable. </p></li><li class="step"><p>To update the bootloader configuration, run the command:</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code> ; <code class="command">update-bootloader</code></pre></div></li><li class="step"><p>The system is now ready to be restarted with the confidential computing kernel. It is not selected as the default kernel in the bootloader, so ensure to select it in the boot menu.</p></li></ol></div></div></section><section class="sect1" id="vm-verify-setup" data-id-title="Verifying setup"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">16.4 </span><span class="title-name">Verifying setup</span></span> <a title="Permalink" class="permalink" href="cha-vm-security.html#vm-verify-setup">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit source document"> </a></div></div></div></div></div><p>You can verify the installation and configuration of the packages.</p><div class="procedure"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>To verify whether the system has started with the new kernel, check the response for the command <code class="command">uname -r</code>.</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code>  <code class="command">uname -r</code> <em class="replaceable">6.4.0-150616.coco15sp6-coco</em></pre></div><p>Ensure that the kernel version displayed contains the coco tag.</p></li><li class="step"><p>To check the initialization result of the AMD Secure Processor in the kernel log when the kernel is running, run the command:</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code>  <code class="command">dmesg | grep -i ccp</code>
[ 10.103166] ccp 0000:42:00.1: enabling device (0000 -&gt; 0002)
[ 10.114951] ccp 0000:42:00.1: no command queues available
[ 10.127137] ccp 0000:42:00.1: sev enabled
[ 10.133152] ccp 0000:42:00.1: psp enabled
[ 10.240817] ccp 0000:42:00.1: SEV firmware update successful
[ 11.128307] ccp 0000:42:00.1: SEV API:1.55 build:8
[ 11.135057] ccp 0000:42:00.1: SEV-SNP API:1.55 build:8</pre></div><p>The message about the SEV-SNP API version indicates the successful initialization of the AMD Secure Processor. Sometimes it happens that these messages do not appear in the kernel log. In this case the BIOS settings or the IOMMU configuration are often the root-cause.</p></li></ol></div></div></section><section class="sect1" id="vm-launch-amd-sv-snp-vm" data-id-title="Launching an AMD SEV-SNP virtual machine"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">16.5 </span><span class="title-name">Launching an AMD SEV-SNP virtual machine</span></span> <a title="Permalink" class="permalink" href="cha-vm-security.html#vm-launch-amd-sv-snp-vm">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit source document"> </a></div></div></div></div></div><p>
You can run AMD SEV-SNP protected virtual machines using the <code class="systemitem">libvirt</code> framework once the confidential computing kernel is booted and the AMD Secure Processor is initialized.</p><p><code class="systemitem">libvirt</code> has several ways of setting up new virtual machines. This document uses a prepared disk image and the virt-manager graphical user interface.</p><div class="procedure"><div class="procedure-contents"><ol class="procedure" type="1"><li class="step"><p>Connect virt-manager to the AMD EPYC host and create a new virtual machine.</p></li><li class="step"><p>In the Create a new virtual machine window, select the details:</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>Select how you want to install the operating system.</p></li><li class="listitem"><p>Select the ISO or CDROM install media.</p></li><li class="listitem"><p>Select the memory and CPU settings.</p></li><li class="listitem"><p>Select the required storage details.</p></li></ul></div></li><li class="step"><p>In the fifth step, verify the details and select <span class="guilabel">Customize configuration before install</span>.</p><div class="figure" id="id-1.12.4.10.7.4.3.2"><div class="figure-contents"><div class="mediaobject"><a href="images/vm_security_create_vm.png"><img src="images/vm_security_create_vm.png" width="75%" alt="Select Customize configuration before install" title="Select Customize configuration before install"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 16.1: </span><span class="title-name">Create Virtual Machine </span></span><a title="Permalink" class="permalink" href="cha-vm-security.html#id-1.12.4.10.7.4.3.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit source document"> </a></div></div></div></li><li class="step"><p>Click <span class="guilabel">Finish</span>.</p></li><li class="step"><p>Select the XML tab in the virtual machine configuration window.</p><p>In the XML tab, you can edit the XML configuration of the virtual machine used by the <code class="systemitem">libvirt</code> back-end.</p><div class="figure" id="id-1.12.4.10.7.4.5.3"><div class="figure-contents"><div class="mediaobject"><a href="images/vm_security_create_vm_xml.png"><img src="images/vm_security_create_vm_xml.png" width="75%" alt="Click XML tab" title="Click XML tab"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 16.2: </span><span class="title-name"><span class="guimenu">XML</span> view of virtual machine configuration </span></span><a title="Permalink" class="permalink" href="cha-vm-security.html#id-1.12.4.10.7.4.5.3">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit source document"> </a></div></div></div></li><li class="step"><p>
To protect the virtual machine with AMD SEV-SNP, set the correct firmware by modifying the <code class="literal">os</code> section as given below:</p><div class="figure" id="id-1.12.4.10.7.4.6.2"><div class="figure-contents"><div class="mediaobject"><a href="images/vm_security_xml_os.png"><img src="images/vm_security_xml_os.png" width="75%" alt="Set firmware" title="Set firmware"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 16.3: </span><span class="title-name">Set firmware </span></span><a title="Permalink" class="permalink" href="cha-vm-security.html#id-1.12.4.10.7.4.6.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit source document"> </a></div></div></div><p>The <code class="literal">loader</code> line sets the firmware to the SEV version of OVMF.</p></li><li class="step"><p>Add a <code class="literal">launchSecurity</code> section. For AMD SEV-SNP, the section looks like this:</p><div class="figure" id="id-1.12.4.10.7.4.7.2"><div class="figure-contents"><div class="mediaobject"><a href="images/vm_security_xml_launchsecurity.png"><img src="images/vm_security_xml_launchsecurity.png" width="75%" alt="Add launchSecurity" title="Add launchSecurity"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 16.4: </span><span class="title-name">launchSecurity </span></span><a title="Permalink" class="permalink" href="cha-vm-security.html#id-1.12.4.10.7.4.7.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit source document"> </a></div></div></div></li><li class="step"><p>Click <span class="guilabel">Apply</span> and then click the <span class="guilabel">Details</span> tab.</p></li><li class="step"><p>Select CPUs in the left-hand list and set the CPU <span class="guilabel">Model</span> to <code class="literal">host-model</code>:</p><div class="figure" id="id-1.12.4.10.7.4.9.2"><div class="figure-contents"><div class="mediaobject"><a href="images/vm_security_create_vm_details.png"><img src="images/vm_security_create_vm_details.png" width="75%" alt="Select CPU model" title="Select CPU model"/></a></div></div><div class="title-container"><div class="figure-title-wrap"><div class="figure-title"><span class="title-number-name"><span class="title-number">Figure 16.5: </span><span class="title-name">The <span class="guimenu">Details</span> view of virtual machine configuration </span></span><a title="Permalink" class="permalink" href="cha-vm-security.html#id-1.12.4.10.7.4.9.2">#</a></div></div><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit source document"> </a></div></div></div></li><li class="step"><p>Click <span class="guilabel">Apply</span> and click <span class="guilabel">Begin Installation</span>.</p><p>This starts the virtual machine and installs it according to your settings. The virtual machine boots up once the process is complete, and you can verify the AMD SEV-SNP protection.</p></li></ol></div></div></section><section class="sect1" id="vm-verify-amd-sv-snp-vm" data-id-title="Verifying the AMD SEV-SNP virtual machine"><div class="titlepage"><div><div><div class="title-container"><h2 class="title"><span class="title-number-name"><span class="title-number">16.6 </span><span class="title-name">Verifying the AMD SEV-SNP virtual machine</span></span> <a title="Permalink" class="permalink" href="cha-vm-security.html#vm-verify-amd-sv-snp-vm">#</a></h2><div class="icons"><a target="_blank" class="icon-reportbug" title="Report an issue"> </a><a target="_blank" class="icon-editsource" href="https://github.com/SUSE/doc-sle/edit/main/xml/vm_security.xml" title="Edit source document"> </a></div></div></div></div></div><p>
From the appearance of the virtual machine, one cannot tell whether it runs in a confidential computing environment. But there are several ways to verify that from within the virtual machine.</p><p>To check the kernel log, run the command:</p><div class="verbatim-wrap"><pre class="screen"><code class="prompt user">&gt; </code><code class="command">sudo</code>  <code class="command">dmesg | grep -i sev-snp</code>
[ 1.986186] Memory Encryption Features active: AMD SEV SEV-ES SEV-SNP</pre></div><p>The presence of the SEV-SNP feature in the kernel log, among other active 
memory encryption features, shows that it is active for the virtual machine.</p><p>There are also cryptographically secure ways to prove the security of the AMD SEV-SNP environment.
</p></section></section><nav class="bottom-pagination"><div><a class="pagination-link prev" href="cha-libvirt-config-virsh.html"><span class="pagination-relation">Previous</span><span class="pagination-label"><span class="title-number">Chapter 15 </span>Configuring virtual machines with <code class="command">virsh</code></span></a> </div><div><a class="pagination-link next" href="sec-libvirt-admin-migrate.html"><span class="pagination-relation">Next</span><span class="pagination-label"><span class="title-number">Chapter 17 </span>Migrating VM Guests</span></a> </div></nav></article><aside id="_side-toc-page" class="side-toc"><div class="side-title">On this page</div><div class="toc"><ul><li><span class="sect1"><a href="cha-vm-security.html#vm-security-hardware-support"><span class="title-number">16.1 </span><span class="title-name">Supported hardware</span></a></span></li><li><span class="sect1"><a href="cha-vm-security.html#vm-security-enable-confidential-compute-module"><span class="title-number">16.2 </span><span class="title-name">Enabling confidential compute module</span></a></span></li><li><span class="sect1"><a href="cha-vm-security.html#vm-security-verify-setup"><span class="title-number">16.3 </span><span class="title-name">Installing packages and setting up the base system</span></a></span></li><li><span class="sect1"><a href="cha-vm-security.html#vm-verify-setup"><span class="title-number">16.4 </span><span class="title-name">Verifying setup</span></a></span></li><li><span class="sect1"><a href="cha-vm-security.html#vm-launch-amd-sv-snp-vm"><span class="title-number">16.5 </span><span class="title-name">Launching an AMD SEV-SNP virtual machine</span></a></span></li><li><span class="sect1"><a href="cha-vm-security.html#vm-verify-amd-sv-snp-vm"><span class="title-number">16.6 </span><span class="title-name">Verifying the AMD SEV-SNP virtual machine</span></a></span></li></ul></div><div class="side-title">Share this page</div><ul class="share"><li><a id="_share-fb" href="#" title="Facebook"> </a></li><li><a id="_share-in" href="#" title="LinkedIn"> </a></li><li><a id="_share-tw" href="#" title="Twitter/X"> </a></li><li><a id="_share-mail" href="#" title="E-Mail"> </a></li><li><a id="_print-button" href="#" title="Print this page"> </a></li></ul> </aside></main><footer id="_footer"><div class="growth-inhibitor"><div class="copy"><span class="copy__rights">© SUSE
                 2024</span></div></div></footer></body></html>